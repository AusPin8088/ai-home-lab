services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant@sha256:17441c45ba14560b4ef727ee06aac4d605cf0dc0625fc4f2e043cb2551d72749
    container_name: homeassistant
    restart: unless-stopped
    ports:
      - "8123:8123"
    environment:
      - TZ=${TZ}
    volumes:
      - ../ha/config:/config
    depends_on:
      - mosquitto
      - influxdb

  mosquitto:
    image: eclipse-mosquitto@sha256:9cfdd46ad59f3e3e5f592f6baf57ab23e1ad00605509d0f5c1e9b179c5314d87
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ../mosquitto/config:/mosquitto/config
      - ../mosquitto/data:/mosquitto/data
      - ../mosquitto/log:/mosquitto/log

  nodered:
    image: nodered/node-red@sha256:7dfe40efdd7b9f21916f083802bfe60a762bc020969d95553ffa020c97a72eb9
    container_name: nodered
    restart: unless-stopped
    ports:
      - "1880:1880"
    environment:
      - TZ=${TZ}
    volumes:
      - ../nodered/data:/data
    depends_on:
      - mosquitto

  influxdb:
    image: quay.io/influxdb/influxdb3-core@sha256:ad4ad468af9b2fbbe92523a5764217916cd1bdd43f578aef504da133ff3f0d0b
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8181:8181"
    environment:
      - TZ=${TZ}
    command:
      - serve
      - --node-id=homelab-node
      - --object-store=file
      - --data-dir=/var/lib/influxdb3
      - --admin-token-file=/run/secrets/admin-token.json
    volumes:
      - ../influxdb3/data:/var/lib/influxdb3
      - ../influxdb3/secrets/admin-token.json:/run/secrets/admin-token.json:ro

  influxdb-init:
    image: quay.io/influxdb/influxdb3-core@sha256:ad4ad468af9b2fbbe92523a5764217916cd1bdd43f578aef504da133ff3f0d0b
    container_name: influxdb-init
    restart: "no"
    environment:
      - INFLUX_URL=http://influxdb:8181
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
    entrypoint: ["/bin/sh", "/scripts/influxdb-init.sh"]
    volumes:
      - ./scripts/influxdb-init.sh:/scripts/influxdb-init.sh:ro
    depends_on:
      - influxdb

  grafana:
    image: grafana/grafana@sha256:5683be4319a6da1d6ab28c3443b3739683e367f8d72d800638390a04a2680c1c
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - TZ=${TZ}
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - INFLUXDB_DATABASE=${INFLUXDB_DATABASE}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
    volumes:
      - ../grafana/data:/var/lib/grafana
      - ../grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      influxdb:
        condition: service_started
      influxdb-init:
        condition: service_completed_successfully

  ollama:
    image: ollama/ollama@sha256:5f7a20da9b4d42d1909b4693f90942135bcabc335ee42d529c0d143c44a92311
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      - TZ=${TZ}
    volumes:
      - ../ollama/data:/root/.ollama

  agent:
    build:
      context: ../services/agent
    container_name: homelab-agent
    restart: unless-stopped
    environment:
      - TZ=${TZ}
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - OLLAMA_URL=http://ollama:11434
      - INFLUX_URL=http://influxdb:8181
      - INFLUX_TOKEN=${INFLUXDB_TOKEN}
      - INFLUX_ORG=${INFLUXDB_ORG}
      - INFLUX_BUCKET=${INFLUXDB_DATABASE}
    depends_on:
      mosquitto:
        condition: service_started
      influxdb:
        condition: service_started
      influxdb-init:
        condition: service_completed_successfully
      ollama:
        condition: service_started
