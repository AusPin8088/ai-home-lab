- id: "p304m_switch_audit_to_mqtt"
  alias: "P304M switch audit to MQTT"
  description: "Publish every P304M switch state change to a dedicated audit topic."
  trigger:
    - platform: mqtt
      topic: home/ha/switch/+/state
  condition:
    - condition: template
      value_template: "{{ 'p304m' in trigger.topic and trigger.payload in ['on', 'off'] }}"
  action:
    - service: mqtt.publish
      data:
        topic: home/automation/p304m/switch_event
        payload: >-
          {"source_topic":"{{ trigger.topic }}","state":"{{ trigger.payload }}","time":"{{ now().isoformat() }}"}
    - service: logbook.log
      data:
        name: "P304M switch"
        message: "{{ trigger.topic }} -> {{ trigger.payload }}"
  mode: queued

- id: "p304m_overheat_overload_alert"
  alias: "P304M overload/overheat alert"
  description: "Create safety alerts when P304M binary sensors report overload/overheat."
  trigger:
    - platform: mqtt
      topic: home/ha/binary_sensor/+/state
  condition:
    - condition: template
      value_template: >-
        {{ 'p304m' in trigger.topic
           and ('overload' in trigger.topic or 'overheat' in trigger.topic)
           and trigger.payload == 'on' }}
  action:
    - variables:
        outlet: >-
          {% if '_p304m_1_' in trigger.topic %}Plug 1
          {% elif '_p304m_2_' in trigger.topic %}Plug 2
          {% elif '_p304m_3_' in trigger.topic %}Plug 3
          {% elif '_p304m_4_' in trigger.topic %}Plug 4
          {% else %}Unknown plug{% endif %}
        alert_type: >-
          {% if 'overheated' in trigger.topic %}Overheat
          {% elif 'overloaded' in trigger.topic %}Overload
          {% else %}Safety alert{% endif %}
        alert_message: >-
          {{ outlet }} {{ alert_type }} detected (state={{ trigger.payload }}) at
          {{ now().strftime('%Y-%m-%d %H:%M:%S') }}.
    - service: mqtt.publish
      data:
        topic: home/automation/p304m/safety_alert
        payload: >-
          {"outlet":"{{ outlet }}","alert_type":"{{ alert_type }}","source_topic":"{{ trigger.topic }}","state":"{{ trigger.payload }}","time":"{{ now().isoformat() }}"}
    - service: rest_command.discord_safety_alert
      continue_on_error: true
      data:
        message: >-
          P304M safety alert | {{ alert_message }}
    - service: notify.notify
      continue_on_error: true
      data:
        title: "P304M safety alert"
        message: "{{ alert_message }}"
    - service: persistent_notification.create
      data:
        title: "P304M safety alert"
        message: "{{ alert_message }}"
        notification_id: p304m_safety_alert
  mode: single

- id: "ai_mode_publish_from_helper"
  alias: "AI mode publish from helper"
  description: "Publish selected AI mode from HA helper to MQTT mode set topic."
  trigger:
    - platform: state
      entity_id: input_select.ai_action_mode
  action:
    - service: mqtt.publish
      data:
        topic: home/ai/mode/set
        payload: "{{ trigger.to_state.state | lower }}"
  mode: queued

- id: "ai_mode_sync_to_helper"
  alias: "AI mode sync to helper"
  description: "Sync helper when agent publishes current mode."
  trigger:
    - platform: mqtt
      topic: home/ai/mode
  condition:
    - condition: template
      value_template: >-
        {{ trigger.payload_json is defined
           and trigger.payload_json.mode is defined
           and trigger.payload_json.mode in ['suggest', 'ask', 'auto'] }}
    - condition: template
      value_template: >-
        {{ states('input_select.ai_action_mode') != trigger.payload_json.mode }}
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.ai_action_mode
      data:
        option: "{{ trigger.payload_json.mode }}"
  mode: queued
